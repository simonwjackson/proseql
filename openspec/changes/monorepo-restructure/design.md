# Monorepo Restructure — Design

## Architecture

### Package Dependency Graph

```
@proseql/core          ← zero Node imports, runtime-agnostic
    ↑          ↑
    │          │
@proseql/node  │       ← re-exports core + NodeStorageLayer
    ↑          │
    │     @proseql/rpc  ← depends on core + @effect/rpc
    │
@proseql/rest           ← depends on core (framework-agnostic HTTP handlers)
```

All packages depend on `@proseql/core` via `"workspace:*"` in their `package.json`. At publish time, Bun/npm resolves `workspace:*` to the actual version.

### Directory Layout

```
plan-text-db/                    (workspace root)
├── flake.nix
├── bun.nix                      (generated by bun2nix, committed)
├── package.json                 (private workspace root)
├── bun.lock
├── tsconfig.base.json
├── biome.json
├── justfile
├── bunfig.toml
│
├── packages/
│   ├── core/
│   │   ├── package.json         "@proseql/core"
│   │   ├── default.nix
│   │   ├── tsconfig.json
│   │   ├── src/                 moved from core/ (minus node-adapter-layer.ts)
│   │   └── tests/               moved from tests/ (minus node-specific tests)
│   │
│   ├── node/
│   │   ├── package.json         "@proseql/node"
│   │   ├── default.nix
│   │   ├── tsconfig.json
│   │   ├── src/
│   │   │   ├── index.ts         re-exports @proseql/core/* + NodeStorageLayer
│   │   │   └── node-adapter-layer.ts
│   │   └── tests/
│   │       └── node-storage.test.ts
│   │
│   ├── rest/
│   │   ├── package.json         "@proseql/rest"
│   │   ├── default.nix
│   │   ├── tsconfig.json
│   │   └── src/
│   │       └── index.ts         from ../proseql-rest/src/
│   │
│   └── rpc/
│       ├── package.json         "@proseql/rpc"
│       ├── default.nix
│       ├── tsconfig.json
│       └── src/
│           └── index.ts         from ../proseql-rpc/src/
│
├── openspec/                    unchanged
├── effect/                      unchanged
├── examples/                    imports updated to @proseql/*
├── CLAUDE.md                    updated paths
└── README.md                    unchanged
```

## Key Decisions

### Scoped packages (`@proseql/*`) over subpath exports

Subpath exports (`proseql`, `proseql/node`, `proseql/browser`) keep consumers to one `npm install` but force all code into a single package. This means browser users download the Node adapter source (even if tree-shaken) and all format codec dependencies.

Scoped packages let each package declare exactly its own dependencies. `@proseql/core` has `effect`, `yaml`, `json5`, etc. `@proseql/node` has only `@proseql/core`. `@proseql/rpc` adds `@effect/rpc`. Clean dependency trees, independent versioning when needed.

### `@proseql/node` re-exports core

Node users install one package and get everything:
```ts
import { createPersistentEffectDatabase, NodeStorageLayer } from "@proseql/node"
```

`packages/node/src/index.ts` is:
```ts
export * from "@proseql/core"
export { NodeStorageLayer, makeNodeStorageLayer } from "./node-adapter-layer.js"
export type { NodeAdapterConfig } from "./node-adapter-layer.js"
```

This means `@proseql/node` is the "batteries-included" package for Node users. `@proseql/core` is for non-Node environments or consumers who bring their own storage adapter.

### Node adapter extraction is one file

Only `core/storage/node-adapter-layer.ts` imports Node builtins (`fs`, `path`, `crypto`). The extraction is:
1. Move that file to `packages/node/src/node-adapter-layer.ts`
2. Update its import of `StorageAdapter` and `StorageError` to `@proseql/core`
3. Remove the re-export from `packages/core/src/index.ts`
4. Move the Node-specific test section from `tests/storage-services.test.ts` to `packages/node/tests/`

### Tests stay as relative imports

Tests import from `../src/...` within their package, not from the package name (`@proseql/core`). This avoids requiring a build step before tests can run — TypeScript source files resolve directly. Bun's test runner handles `.ts` imports natively.

### `tsconfig.base.json` with project references

Shared compiler options in `tsconfig.base.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "esnext",
    "moduleResolution": "bundler",
    "strict": true,
    "declaration": true,
    "declarationMap": true,
    "composite": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "paths": {
      "@proseql/core": ["./packages/core/src/index.ts"],
      "@proseql/core/*": ["./packages/core/src/*"]
    }
  }
}
```

Per-package `tsconfig.json` extends the base:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "rootDir": "src",
    "outDir": "dist"
  },
  "include": ["src"],
  "references": []
}
```

`packages/node/tsconfig.json` adds:
```json
{
  "references": [{ "path": "../core" }]
}
```

### Nix flake with bun2nix

`flake.nix` provides:
- `devShells.default`: bun, biome, just, bun2nix, git
- `packages.{core,node,rest,rpc}`: hermetic builds via `mkBunDerivation`
- `checks.default`: tests + typecheck (CI equivalent)

`bun.nix` is generated by `bun2nix` from `bun.lock` and committed. The `postinstall` script in root `package.json` regenerates it:
```json
{ "scripts": { "postinstall": "bun2nix -o bun.nix" } }
```

Per-package `default.nix` uses the workspace-aware `mkBunDerivation`:
```nix
{ mkBunDerivation, ... }:
mkBunDerivation {
  pname = "proseql-core";
  version = "0.1.0";
  src = ../../.;
  bunNix = ../../bun.nix;
  workspaceRoot = ../../.;
}
```

### Justfile orchestration

```just
test *args:
    bun test {{args}}

test-core:
    bun test packages/core/tests/

test-node:
    bun test packages/node/tests/

typecheck:
    bunx tsc --build

lint:
    biome check .

format:
    biome format --write .

clean:
    rm -rf packages/*/dist packages/*/.tsbuildinfo
```

### Root `package.json`

```json
{
  "private": true,
  "workspaces": ["packages/*"],
  "scripts": {
    "postinstall": "bun2nix -o bun.nix"
  },
  "devDependencies": {
    "@types/bun": "^1.2.17",
    "vitest": "^1.1.1"
  }
}
```

Shared dev dependencies live at the root. Package-specific dependencies live in each package.

## Error Handling

No new error types. This is a structural change only.

## File Layout

See directory layout above. The critical moves:

| Source | Destination |
|---|---|
| `core/*` (except node-adapter) | `packages/core/src/*` |
| `core/storage/node-adapter-layer.ts` | `packages/node/src/node-adapter-layer.ts` |
| `core/index.ts` | `packages/core/src/index.ts` (NodeStorage exports removed) |
| `tests/*` (most) | `packages/core/tests/*` |
| `tests/storage-services.test.ts` (node section) | `packages/node/tests/node-storage.test.ts` |
| `../proseql-rest/src/index.ts` | `packages/rest/src/index.ts` |
| `../proseql-rpc/src/index.ts` | `packages/rpc/src/index.ts` |
| `shell.nix` | deleted (replaced by `flake.nix`) |
| `package.json` | replaced with workspace root |
| `tsconfig.json` | replaced with `tsconfig.base.json` |
