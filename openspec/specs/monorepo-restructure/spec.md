# Monorepo Restructure

## Overview

Restructure the proseql repository from a single-package layout into a Nix-based Bun workspace monorepo with scoped `@proseql/*` packages. This is the prerequisite for browser support, the CLI, and all ecosystem packages. The restructure absorbs two existing stub repos (`proseql-rest`, `proseql-rpc`) and extracts the Node.js storage adapter into its own package so the core remains runtime-agnostic.

## Current State

```
proseql/                    ← single package, "proseql" v0.0.0
├── shell.nix                    ← basic dev shell (not a flake)
├── package.json                 ← single package, all deps
├── core/                        ← all source (includes Node adapter)
│   ├── index.ts                 ← barrel export (re-exports node adapter)
│   ├── storage/node-adapter-layer.ts  ← ONLY file with Node imports
│   └── ...
├── tests/                       ← all tests (import from ../core/)
├── openspec/
├── effect/                      ← vendored Effect reference
└── examples/

../proseql-rest/                 ← separate repo, stub only
../proseql-rpc/                  ← separate repo, stub only
```

## Target State

```
proseql/                    ← workspace root (directory name unchanged)
├── flake.nix                    ← Nix flake: dev shell + per-package builds
├── flake.lock
├── bun.nix                      ← generated by bun2nix from bun.lock
├── package.json                 ← workspace root (private, "workspaces": ["packages/*"])
├── bun.lock
├── tsconfig.base.json           ← shared TypeScript config
├── biome.json
├── justfile                     ← top-level task orchestration
├── bunfig.toml
│
├── packages/
│   ├── core/                    ← "@proseql/core" — runtime-agnostic engine
│   │   ├── package.json
│   │   ├── default.nix
│   │   ├── tsconfig.json
│   │   ├── src/                 ← moved from core/ (minus node-adapter-layer.ts)
│   │   │   ├── index.ts         ← barrel (no Node exports)
│   │   │   ├── errors/
│   │   │   ├── factories/
│   │   │   ├── hooks/
│   │   │   ├── indexes/
│   │   │   ├── migrations/
│   │   │   ├── operations/
│   │   │   ├── serializers/
│   │   │   ├── state/
│   │   │   ├── storage/         ← StorageAdapter service + in-memory adapter
│   │   │   ├── transactions/
│   │   │   ├── types/
│   │   │   ├── utils/
│   │   │   └── validators/
│   │   └── tests/               ← moved from tests/ (core-only tests)
│   │
│   ├── node/                    ← "@proseql/node" — Node.js fs adapter
│   │   ├── package.json         ← depends on @proseql/core
│   │   ├── default.nix
│   │   ├── tsconfig.json
│   │   ├── src/
│   │   │   ├── index.ts         ← re-exports @proseql/core + NodeStorageLayer
│   │   │   └── node-adapter-layer.ts  ← moved from core/storage/
│   │   └── tests/               ← node-specific tests (storage-services node test)
│   │
│   ├── rest/                    ← "@proseql/rest" — REST API generation
│   │   ├── package.json         ← depends on @proseql/core
│   │   ├── default.nix
│   │   ├── tsconfig.json
│   │   ├── src/
│   │   │   └── index.ts         ← from proseql-rest stub
│   │   └── tests/
│   │
│   └── rpc/                     ← "@proseql/rpc" — Effect RPC layer
│       ├── package.json         ← depends on @proseql/core, @effect/rpc
│       ├── default.nix
│       ├── tsconfig.json
│       ├── src/
│       │   └── index.ts         ← from proseql-rpc stub
│       └── tests/
│
├── openspec/                    ← unchanged, stays at root
├── effect/                      ← vendored reference, stays at root
└── examples/                    ← stays at root, imports from @proseql/*
```

## Requirements

### Requirement: Bun workspace configuration

The root `package.json` SHALL define a Bun workspace encompassing all packages.

#### Scenario: Workspace root
- **THEN** root `package.json` SHALL have:
  - `"private": true`
  - `"workspaces": ["packages/*"]`
  - `"scripts": { "postinstall": "bun2nix -o bun.nix" }`
  - No `name` field (or a private name like `proseql-monorepo`)

#### Scenario: Workspace linking
- **WHEN** `bun install` is run at the workspace root
- **THEN** all `@proseql/*` packages SHALL be symlinked in `node_modules/@proseql/`
- **AND** cross-package imports SHALL resolve correctly

### Requirement: Package extraction — @proseql/core

The core package SHALL contain all runtime-agnostic database engine code.

#### Scenario: No Node.js imports
- **THEN** no file in `packages/core/src/` SHALL import from `fs`, `path`, `crypto`, or any `node:*` module
- **AND** `core/storage/node-adapter-layer.ts` SHALL NOT exist in the core package

#### Scenario: Core barrel export
- **THEN** `packages/core/src/index.ts` SHALL export everything the current `core/index.ts` exports EXCEPT:
  - `NodeStorageLayer`
  - `makeNodeStorageLayer`
  - `NodeAdapterConfig` type

#### Scenario: Core package.json
- **THEN** `packages/core/package.json` SHALL have:
  - `"name": "@proseql/core"`
  - `"type": "module"`
  - `"dependencies"`: effect, yaml, json5, jsonc-parser, smol-toml, @toon-format/toon, hjson
  - `"peerDependencies"`: none
  - No Node.js-specific dependencies

### Requirement: Package extraction — @proseql/node

The node package SHALL provide the Node.js filesystem storage adapter.

#### Scenario: Re-exports core
- **THEN** `packages/node/src/index.ts` SHALL re-export everything from `@proseql/core`
- **AND** additionally export `NodeStorageLayer`, `makeNodeStorageLayer`, `NodeAdapterConfig`

#### Scenario: Node package.json
- **THEN** `packages/node/package.json` SHALL have:
  - `"name": "@proseql/node"`
  - `"dependencies"`: `{ "@proseql/core": "workspace:*" }`
  - No additional runtime dependencies (Node APIs are built-in)

#### Scenario: Convenience for Node users
- **WHEN** a Node.js consumer installs `@proseql/node`
- **THEN** they SHALL get access to both the core API and the Node storage adapter from a single import:
  ```ts
  import { createPersistentEffectDatabase, NodeStorageLayer } from "@proseql/node"
  ```

### Requirement: Package absorption — @proseql/rest

The proseql-rest stub SHALL be absorbed into the monorepo.

#### Scenario: Rest package
- **THEN** `packages/rest/` SHALL contain the stub from `../proseql-rest/`
- **AND** `package.json` SHALL be updated:
  - `"name": "@proseql/rest"`
  - `"dependencies"`: `{ "@proseql/core": "workspace:*" }`
  - `"peerDependencies"`: `{ "effect": "^3.15.0" }`

### Requirement: Package absorption — @proseql/rpc

The proseql-rpc stub SHALL be absorbed into the monorepo.

#### Scenario: Rpc package
- **THEN** `packages/rpc/` SHALL contain the stub from `../proseql-rpc/`
- **AND** `package.json` SHALL be updated:
  - `"name": "@proseql/rpc"`
  - `"dependencies"`: `{ "@proseql/core": "workspace:*", "@effect/rpc": "^0.51.0" }`
  - `"peerDependencies"`: `{ "effect": "^3.15.0" }`

### Requirement: Test migration

All 1591 existing tests SHALL pass after the restructure.

#### Scenario: Tests move to packages
- **THEN** test files SHALL move to the package they test:
  - Most tests → `packages/core/tests/`
  - Node adapter tests (storage-services.test.ts node section) → `packages/node/tests/`

#### Scenario: Import path updates
- **THEN** all test imports SHALL be updated from `../core/...` to relative paths within the package (e.g., `../src/...`)
- **OR** tests MAY import from the package name (`@proseql/core`) if workspace resolution supports it in test context

#### Scenario: Test runner config
- **THEN** the root `justfile` SHALL support:
  - `just test` — runs tests across all packages
  - `just test core` — runs only core tests
  - `just test node` — runs only node tests
- **AND** `bunfig.toml` or per-package test config SHALL be updated accordingly

#### Scenario: All tests pass
- **WHEN** `just test` is run after restructure
- **THEN** all 1591 tests SHALL pass with zero failures

### Requirement: TypeScript project references

Each package SHALL have its own `tsconfig.json` that extends a shared base.

#### Scenario: Shared base config
- **THEN** `tsconfig.base.json` at the root SHALL contain shared compiler options:
  - `target: "ES2022"`, `module: "esnext"`, `strict: true`
  - `declaration: true`, `declarationMap: true`
  - `composite: true` (enables project references)
  - Path mappings for `@proseql/*` → `packages/*/src`

#### Scenario: Per-package tsconfig
- **THEN** each `packages/*/tsconfig.json` SHALL:
  - Extend `../../tsconfig.base.json`
  - Set `rootDir`, `outDir` for its own package
  - Declare `references` to dependency packages (e.g., node references core)

#### Scenario: Typecheck all
- **WHEN** `bunx tsc --build` is run at the root
- **THEN** all packages SHALL typecheck successfully

### Requirement: Nix flake

A `flake.nix` SHALL provide reproducible development and build environments.

#### Scenario: Dev shell
- **WHEN** `nix develop` is run
- **THEN** a shell SHALL be available with: `bun`, `biome`, `just`, `bun2nix`, `git`

#### Scenario: Per-package build
- **WHEN** `nix build .#core` is run
- **THEN** `@proseql/core` SHALL be built hermetically using bun2nix
- **AND** the output SHALL contain compiled JS + declaration files

#### Scenario: Flake check
- **WHEN** `nix flake check` is run
- **THEN** it SHALL run tests and typechecking for all packages

#### Scenario: bun2nix integration
- **THEN** `bun.nix` SHALL be generated by `bun2nix` from `bun.lock`
- **AND** `package.json` SHALL include a `postinstall` script that regenerates `bun.nix`
- **AND** `bun.nix` SHALL be committed to the repo (it's a lockfile equivalent)

#### Scenario: Per-package default.nix
- **THEN** each package SHALL have a `default.nix` using `mkBunDerivation`:
  ```nix
  { mkBunDerivation, ... }:
  mkBunDerivation {
    pname = "proseql-core";
    version = "0.1.0";
    src = ../../.;
    bunNix = ../../bun.nix;
    workspaceRoot = ../../.;
  }
  ```

### Requirement: Justfile orchestration

The root `justfile` SHALL orchestrate common tasks across all packages.

#### Scenario: Available recipes
- **THEN** the following recipes SHALL be available:
  - `just test` — test all packages
  - `just test <pkg>` — test specific package
  - `just typecheck` — typecheck all packages via tsc --build
  - `just lint` — biome lint all packages
  - `just format` — biome format all packages
  - `just clean` — remove all dist/ and .tsbuildinfo
  - `just build` — build all packages

### Requirement: Existing files preserved at root

Non-package files SHALL remain at the repository root.

#### Scenario: Root files
- **THEN** the following SHALL remain at the root, unchanged:
  - `openspec/` — specs and changes
  - `effect/` — vendored Effect reference
  - `examples/` — example code (imports updated to `@proseql/*`)
  - `CLAUDE.md` — project instructions
  - `README.md` — project readme
  - `biome.json` — shared linter config
  - `.gitignore`

### Requirement: Old stubs cleaned up

After absorption, the external stub repos are no longer needed.

#### Scenario: Stubs absorbed
- **THEN** after the restructure, `../proseql-rest/` and `../proseql-rpc/` content SHALL live in `packages/rest/` and `packages/rpc/`
- **AND** the original stub directories MAY be deleted (user's choice, not automated)

## Migration Checklist

This is a big-bang restructure. The steps in order:

1. Create workspace root `package.json`
2. Create `tsconfig.base.json`
3. Create `packages/core/` — move `core/` → `packages/core/src/`, remove node adapter from barrel
4. Create `packages/node/` — move `node-adapter-layer.ts`, create re-export barrel
5. Create `packages/rest/` — absorb `../proseql-rest/src/`
6. Create `packages/rpc/` — absorb `../proseql-rpc/src/`
7. Move `tests/` → `packages/core/tests/` + `packages/node/tests/`
8. Update all import paths in tests
9. Create per-package `package.json` files with workspace dependencies
10. Create per-package `tsconfig.json` files
11. Update `bunfig.toml` for workspace test roots
12. Update `justfile` for workspace commands
13. Update `examples/` imports
14. Delete old `core/` and `tests/` directories
15. Run `bun install` — verify workspace linking
16. Run all tests — verify 1591 pass
17. Run typecheck — verify clean
18. Create `flake.nix` with bun2nix integration
19. Create per-package `default.nix` files
20. Run `nix develop` — verify dev shell
21. Run `nix build .#core` — verify hermetic build
22. Run `nix flake check` — verify CI equivalent

## Out of Scope

- Renaming the repository directory (stays `proseql`)
- npm publishing configuration (covered by build-and-publish spec)
- Creating `packages/browser/`, `packages/sync/`, `packages/cli/` (future packages, added when needed)
- CI pipeline setup (covered by ci-pipeline spec)
- Deleting the external stub repos (user's manual decision)
